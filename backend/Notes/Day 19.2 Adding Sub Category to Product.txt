package com.advann.product_service.entity;

import jakarta.persistence.*;
import jakarta.validation.constraints.*;
import lombok.*;

import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.List;

@Entity
@Table(name = "products")
@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class Product {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @NotBlank(message = "Product name cannot be empty.")
    @Column(nullable = false)
    private String name;

    @NotNull(message = "Product price cannot be null.")
    @DecimalMin(value = "0.0", inclusive = false, message = "Product price must be greater than 0.")
    @Column(nullable = false)
    private BigDecimal price;

    @NotNull(message = "Product quantity cannot be null.")
    @Min(value = 1, message = "Product quantity must be at least 1.")
    @Column(nullable = false)
    private Integer quantity;

    @ManyToOne
    @JoinColumn(name = "category_id")
    private Category category;

    @ManyToOne
    @JoinColumn(name = "sub_category_id")
    private SubCategory subCategory;

    @Column(name = "image_path")
    private String imagePath;

    @OneToMany(mappedBy = "product", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<ProductImage> images = new ArrayList<>();
}

===========================================================================================================================

package com.advann.product_service.dto;

import jakarta.validation.constraints.DecimalMin;
import jakarta.validation.constraints.Min;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotNull;
import lombok.Data;

import java.math.BigDecimal;

@Data
public class ProductRequestDto {
    @NotBlank(message = "Product name cannot be blank")
    private String name;

    @NotNull(message = "Price cannot be null")
    //inclusive = false means the minimum value is not allowed, so the number must be strictly greater than the given value (ex: price must be > 0.0).
    @DecimalMin(value = "0.0", inclusive = false, message = "Price should be greater than 0")
    private BigDecimal price;

    @NotNull(message = "Quantity cannot be null")
    @Min(value = 1, message = "Quantity must be at least 1")
    private Integer quantity;

    @NotNull(message = "Category Id is required")
    private Long categoryId;

    @NotNull(message = "SubCategory Id is required")
    private Long subCategoryId;
}

============================================================================================================================

package com.advann.product_service.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.math.BigDecimal;

@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class ProductResponseDto {
    private Long id;
    private String name;
    private BigDecimal price;
    private Integer quantity;

    private String imagePath;
    private String imageUrl;

    private Long categoryId;
    private String categoryName;

    private Long subCategoryId;
    private String subCategoryName;
}

=============================================================================================================================

package com.advann.product_service.service.serviceImpl;

import com.advann.product_service.dto.PagedResponseDto;
import com.advann.product_service.dto.ProductImageResponseDto;
import com.advann.product_service.dto.ProductRequestDto;
import com.advann.product_service.dto.ProductResponseDto;
import com.advann.product_service.entity.Category;
import com.advann.product_service.entity.Product;
import com.advann.product_service.entity.ProductImage;
import com.advann.product_service.entity.SubCategory;
import com.advann.product_service.exceptions.InvalidFileException;
import com.advann.product_service.exceptions.ResourceNotFoundException;
import com.advann.product_service.repository.CategoryRepository;
import com.advann.product_service.repository.ProductImageRepository;
import com.advann.product_service.repository.ProductRepository;
import com.advann.product_service.repository.SubCategoryRepository;
import com.advann.product_service.service.services.ProductService;
import com.advann.product_service.service.services.S3Service;
import lombok.RequiredArgsConstructor;
import net.coobird.thumbnailator.Thumbnails;
import org.modelmapper.ModelMapper;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.data.domain.*;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import java.io.ByteArrayOutputStream;
import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class ProductServiceImpl implements ProductService {

    private static final Logger log = LoggerFactory.getLogger(ProductServiceImpl.class);

    private final ProductRepository productRepository;
    private final ModelMapper modelMapper;
    private final CategoryRepository categoryRepository;
    private final SubCategoryRepository subCategoryRepository;
    private final ProductImageRepository productImageRepository;
    private final S3Service s3Service;

    @Value("${app.base-url}")
    private String baseUrl;

    private static final int MAX_GALLERY_IMAGES = 5;

    @Override
    public ProductResponseDto addProduct(ProductRequestDto productRequestDto) {

        log.info("Creating new product with name: {}", productRequestDto.getName());

        Product product = modelMapper.map(productRequestDto, Product.class);
        product.setId(null);

        Category category = categoryRepository.findById(productRequestDto.getCategoryId())
                .orElseThrow(() -> new ResourceNotFoundException(
                        "Category not found with id: " + productRequestDto.getCategoryId()
                ));

        SubCategory subCategory = subCategoryRepository.findById(productRequestDto.getSubCategoryId())
                .orElseThrow(() -> new ResourceNotFoundException(
                        "SubCategory not found with id: " + productRequestDto.getSubCategoryId()
                ));

        if (!subCategory.getCategory().getId().equals(category.getId())) {
            throw new ResourceNotFoundException(
                    "SubCategory id " + productRequestDto.getSubCategoryId() +
                            " does not belong to Category id " + productRequestDto.getCategoryId()
            );
        }

        product.setCategory(category);
        product.setSubCategory(subCategory);

        Product savedProduct = productRepository.save(product);

        log.info("Product created successfully with id: {}", savedProduct.getId());

        ProductResponseDto responseDto = modelMapper.map(savedProduct, ProductResponseDto.class);

        responseDto.setCategoryId(category.getId());
        responseDto.setCategoryName(category.getName());

        responseDto.setSubCategoryId(subCategory.getId());
        responseDto.setSubCategoryName(subCategory.getName());

        responseDto.setImageUrl(buildImageUrl(savedProduct.getImagePath()));

        return responseDto;
    }

    @Override
    public List<ProductResponseDto> getAllProducts() {

        log.info("Fetching all products");

        List<Product> products = productRepository.findAll();

        log.info("Total products found: {}", products.size());

        return products.stream()
                .map(product -> {

                    ProductResponseDto dto = modelMapper.map(product, ProductResponseDto.class);

                    dto.setImageUrl(buildImageUrl(product.getImagePath()));

                    if (product.getCategory() != null) {
                        dto.setCategoryId(product.getCategory().getId());
                        dto.setCategoryName(product.getCategory().getName());
                    }

                    if (product.getSubCategory() != null) {
                        dto.setSubCategoryId(product.getSubCategory().getId());
                        dto.setSubCategoryName(product.getSubCategory().getName());
                    }

                    return dto;
                })
                .collect(Collectors.toList());
    }

    @Override
    public ProductResponseDto getProductById(Long id) {

        log.info("Fetching product by id: {}", id);

        Product product = productRepository.findById(id)
                .orElseThrow(() -> {
                    log.warn("Product not found with id: {}", id);
                    return new ResourceNotFoundException("Product not found with id: " + id);
                });

        ProductResponseDto dto = modelMapper.map(product, ProductResponseDto.class);

        dto.setImageUrl(buildImageUrl(product.getImagePath()));

        if (product.getCategory() != null) {
            dto.setCategoryId(product.getCategory().getId());
            dto.setCategoryName(product.getCategory().getName());
        }

        if (product.getSubCategory() != null) {
            dto.setSubCategoryId(product.getSubCategory().getId());
            dto.setSubCategoryName(product.getSubCategory().getName());
        }

        return dto;
    }

    @Override
    public ProductResponseDto updateProduct(Long id, ProductRequestDto productRequestDto) {

        log.info("Updating product with id: {}", id);

        Product existing = productRepository.findById(id)
                .orElseThrow(() -> {
                    log.warn("Cannot update. Product not found with id: {}", id);
                    return new ResourceNotFoundException("Product not found with id: " + id);
                });

        existing.setName(productRequestDto.getName());
        existing.setPrice(productRequestDto.getPrice());
        existing.setQuantity(productRequestDto.getQuantity());

        Category category = categoryRepository.findById(productRequestDto.getCategoryId())
                .orElseThrow(() -> new ResourceNotFoundException(
                        "Category not found with id: " + productRequestDto.getCategoryId()
                ));

        SubCategory subCategory = subCategoryRepository.findById(productRequestDto.getSubCategoryId())
                .orElseThrow(() -> new ResourceNotFoundException(
                        "SubCategory not found with id: " + productRequestDto.getSubCategoryId()
                ));

        if (!subCategory.getCategory().getId().equals(category.getId())) {
            throw new ResourceNotFoundException(
                    "SubCategory id " + productRequestDto.getSubCategoryId() +
                            " does not belong to Category id " + productRequestDto.getCategoryId()
            );
        }

        existing.setCategory(category);
        existing.setSubCategory(subCategory);

        Product updated = productRepository.save(existing);

        ProductResponseDto responseDto = modelMapper.map(updated, ProductResponseDto.class);

        responseDto.setCategoryId(category.getId());
        responseDto.setCategoryName(category.getName());

        responseDto.setSubCategoryId(subCategory.getId());
        responseDto.setSubCategoryName(subCategory.getName());

        responseDto.setImageUrl(buildImageUrl(updated.getImagePath()));

        return responseDto;
    }

    @Override
    public void deleteProduct(Long id) {

        log.info("Deleting product with id: {}", id);

        Product existing = productRepository.findById(id)
                .orElseThrow(() -> {
                    log.warn("Cannot delete. Product not found with id: {}", id);
                    return new ResourceNotFoundException("Product not found with id: " + id);
                });

        // ✅ delete primary image from S3
        deleteOldImageIfExists(existing);

        // ✅ delete gallery images from S3
        List<ProductImage> images = productImageRepository.findByProductId(existing.getId());

        for (ProductImage img : images) {
            if (img.getImagePath() != null) {
                s3Service.deleteFileByUrl(img.getImagePath());
            }
            if (img.getThumbnailPath() != null) {
                s3Service.deleteFileByUrl(img.getThumbnailPath());
            }
        }

        productRepository.delete(existing);

        log.info("Product deleted successfully with id: {}", id);
    }

    @Override
    public PagedResponseDto<ProductResponseDto> getAllProducts(
            int page,
            int size,
            String sortBy,
            String sortDir,
            String keyword,
            Long categoryId
    ) {

        Sort sort = sortDir.equalsIgnoreCase("desc")
                ? Sort.by(sortBy).descending()
                : Sort.by(sortBy).ascending();

        Pageable pageable = PageRequest.of(page, size, sort);

        Page<Product> productPage;

        if (categoryId != null && keyword != null && !keyword.isBlank()) {
            productPage = productRepository.findByCategoryIdAndNameContainingIgnoreCase(categoryId, keyword, pageable);
        } else if (categoryId != null) {
            productPage = productRepository.findByCategoryId(categoryId, pageable);
        } else if (keyword != null && !keyword.isBlank()) {
            productPage = productRepository.findByNameContainingIgnoreCase(keyword, pageable);
        } else {
            productPage = productRepository.findAll(pageable);
        }

        List<ProductResponseDto> products = productPage.getContent()
                .stream()
                .map(product -> ProductResponseDto.builder()
                        .id(product.getId())
                        .name(product.getName())
                        .price(product.getPrice())
                        .quantity(product.getQuantity())

                        .categoryId(product.getCategory() != null ? product.getCategory().getId() : null)
                        .categoryName(product.getCategory() != null ? product.getCategory().getName() : null)

                        .subCategoryId(product.getSubCategory() != null ? product.getSubCategory().getId() : null)
                        .subCategoryName(product.getSubCategory() != null ? product.getSubCategory().getName() : null)

                        .imagePath(product.getImagePath())
                        .imageUrl(buildImageUrl(product.getImagePath()))
                        .build()
                )
                .toList();

        return PagedResponseDto.<ProductResponseDto>builder()
                .content(products)
                .pageNumber(productPage.getNumber())
                .pageSize(productPage.getSize())
                .totalElements(productPage.getTotalElements())
                .totalPages(productPage.getTotalPages())
                .last(productPage.isLast())
                .build();
    }

    @Override
    public ProductResponseDto uploadProductImage(Long productId, MultipartFile file) {

        Product product = productRepository.findById(productId)
                .orElseThrow(() -> new ResourceNotFoundException("Product not found with id: " + productId));

        validateImageFile(file);

        String imageUrl = s3Service.uploadFile(file, "products/full");

        product.setImagePath(imageUrl);

        Product savedProduct = productRepository.save(product);

        ProductResponseDto dto = modelMapper.map(savedProduct, ProductResponseDto.class);
        dto.setImageUrl(savedProduct.getImagePath());

        return dto;
    }

    private void validateImageFile(MultipartFile file) {

        if (file == null || file.isEmpty()) {
            throw new InvalidFileException("File is required. Please upload a file.");
        }

        String contentType = file.getContentType();

        if (contentType == null ||
                !(contentType.equals("image/jpeg") ||
                        contentType.equals("image/png"))) {
            throw new InvalidFileException("Only JPG and PNG images are allowed");
        }

        long maxSize = 2 * 1024 * 1024;
        if (file.getSize() > maxSize) {
            throw new InvalidFileException("File size must be less than 2MB");
        }
    }

    private void deleteOldImageIfExists(Product product) {

        if (product.getImagePath() == null || product.getImagePath().isBlank()) {
            log.info("No primary image found for product id: {}", product.getId());
            return;
        }

        try {
            s3Service.deleteFileByUrl(product.getImagePath());
            log.info("Old primary image deleted from S3 for product id: {}", product.getId());
        } catch (Exception e) {
            log.warn("Failed to delete old image from S3. Skipping delete. {}", e.getMessage());
        }
    }

    private String buildImageUrl(String imagePath) {

        if (imagePath == null || imagePath.isBlank()) {
            return baseUrl + "/images/default.jpg";
        }

        // ✅ S3 imagePath already contains full URL
        return imagePath;
    }

    @Override
    public ProductResponseDto deleteProductImage(Long productId) {

        Product product = productRepository.findById(productId)
                .orElseThrow(() -> new ResourceNotFoundException("Product not found with id: " + productId));

        if (product.getImagePath() == null || product.getImagePath().isBlank()) {
            throw new InvalidFileException("No image found for this product.");
        }

        // ✅ delete from S3
        s3Service.deleteFileByUrl(product.getImagePath());

        product.setImagePath(null);

        Product savedProduct = productRepository.save(product);

        ProductResponseDto dto = modelMapper.map(savedProduct, ProductResponseDto.class);
        dto.setImageUrl(null);

        return dto;
    }

    @Override
    public ProductResponseDto updateProductImage(Long productId, MultipartFile file) {

        Product product = productRepository.findById(productId)
                .orElseThrow(() -> new ResourceNotFoundException("Product not found with id: " + productId));

        validateImageFile(file);

        // ✅ delete old primary image from S3
        deleteOldImageIfExists(product);

        // ✅ upload new image to S3
        String imageUrl = s3Service.uploadFile(file, "products/full");

        product.setImagePath(imageUrl);

        Product savedProduct = productRepository.save(product);

        ProductResponseDto dto = modelMapper.map(savedProduct, ProductResponseDto.class);
        dto.setImageUrl(savedProduct.getImagePath());

        return dto;
    }

    @Override
    public List<ProductImageResponseDto> uploadProductImages(Long productId, List<MultipartFile> files) {

        Product product = productRepository.findById(productId)
                .orElseThrow(() -> new ResourceNotFoundException("Product not found with id: " + productId));

        if (files == null || files.isEmpty()) {
            throw new InvalidFileException("Please upload at least one image.");
        }

        long existingCount = productImageRepository.countByProductId(productId);

        if (existingCount + files.size() > MAX_GALLERY_IMAGES) {
            throw new InvalidFileException(
                    "Maximum " + MAX_GALLERY_IMAGES + " images allowed per product. Already uploaded: "
                            + existingCount + ", trying to upload: " + files.size()
            );
        }

        List<ProductImageResponseDto> responseList = new ArrayList<>();

        for (MultipartFile file : files) {

            validateImageFile(file);

            try {
                ByteArrayOutputStream fullOutputStream = new ByteArrayOutputStream();

                Thumbnails.of(file.getInputStream())
                        .size(800, 800)
                        .outputQuality(0.8)
                        .toOutputStream(fullOutputStream);

                byte[] fullBytes = fullOutputStream.toByteArray();

                ByteArrayOutputStream thumbOutputStream = new ByteArrayOutputStream();

                Thumbnails.of(file.getInputStream())
                        .size(300, 300)
                        .outputQuality(0.7)
                        .toOutputStream(thumbOutputStream);

                byte[] thumbBytes = thumbOutputStream.toByteArray();

                String fullImageUrl = s3Service.uploadBytes(fullBytes, file.getContentType(), "products/gallery/full");
                String thumbImageUrl = s3Service.uploadBytes(thumbBytes, file.getContentType(), "products/gallery/thumb");

                ProductImage productImage = ProductImage.builder()
                        .imagePath(fullImageUrl)
                        .thumbnailPath(thumbImageUrl)
                        .product(product)
                        .build();

                ProductImage savedImage = productImageRepository.save(productImage);

                responseList.add(ProductImageResponseDto.builder()
                        .id(savedImage.getId())
                        .imagePath(savedImage.getImagePath())
                        .imageUrl(savedImage.getImagePath())
                        .thumbnailPath(savedImage.getThumbnailPath())
                        .thumbnailUrl(savedImage.getThumbnailPath())
                        .build());

            } catch (Exception e) {
                throw new InvalidFileException("Failed to upload image to S3.");
            }
        }

        if (!responseList.isEmpty()) {
            ProductImageResponseDto latestUploadedImage = responseList.get(responseList.size() - 1);

            product.setImagePath(latestUploadedImage.getImagePath());
            productRepository.save(product);

            log.info("Primary image updated to latest uploaded image for product id: {}", product.getId());
        }

        return responseList;
    }

    @Override
    public List<ProductImageResponseDto> getProductImages(Long productId) {

        productRepository.findById(productId)
                .orElseThrow(() -> new ResourceNotFoundException("Product not found with id: " + productId));

        List<ProductImage> images = productImageRepository.findByProductId(productId);

        return images.stream()
                .map(img -> ProductImageResponseDto.builder()
                        .id(img.getId())
                        .imagePath(img.getImagePath())
                        .imageUrl(img.getImagePath())
                        .thumbnailPath(img.getThumbnailPath())
                        .thumbnailUrl(img.getThumbnailPath())
                        .build())
                .toList();
    }

    @Override
    public void deleteProductImageById(Long imageId) {

        ProductImage productImage = productImageRepository.findById(imageId)
                .orElseThrow(() -> new ResourceNotFoundException("Image not found with id: " + imageId));

        Product product = productImage.getProduct();

        boolean isPrimary = product.getImagePath() != null &&
                product.getImagePath().equals(productImage.getImagePath());

        // ✅ delete full image from S3
        if (productImage.getImagePath() != null) {
            s3Service.deleteFileByUrl(productImage.getImagePath());
        }

        // ✅ delete thumbnail from S3
        if (productImage.getThumbnailPath() != null) {
            s3Service.deleteFileByUrl(productImage.getThumbnailPath());
        }

        productImageRepository.delete(productImage);
        log.info("Gallery image deleted from DB with id: {}", imageId);

        if (isPrimary) {

            List<ProductImage> remainingImages =
                    productImageRepository.findByProductIdOrderByCreatedAtDesc(product.getId());

            if (!remainingImages.isEmpty()) {
                product.setImagePath(remainingImages.get(0).getImagePath());
                log.info("Primary image updated to another gallery image for product id: {}", product.getId());
            } else {
                product.setImagePath(null);
                log.info("No gallery images left. Primary image reset to null for product id: {}", product.getId());
            }

            productRepository.save(product);
        }
    }

    @Override
    public ProductResponseDto setPrimaryProductImage(Long imageId) {

        ProductImage productImage = productImageRepository.findById(imageId)
                .orElseThrow(() -> new ResourceNotFoundException("Image not found with id: " + imageId));

        Product product = productImage.getProduct();

        product.setImagePath(productImage.getImagePath());

        Product savedProduct = productRepository.save(product);

        ProductResponseDto dto = modelMapper.map(savedProduct, ProductResponseDto.class);
        dto.setImageUrl(savedProduct.getImagePath());

        return dto;
    }

    @Override
    public PagedResponseDto<ProductImageResponseDto> getProductImagesWithPagination(Long productId, int page, int size, String sortDir) {

        productRepository.findById(productId)
                .orElseThrow(() -> new ResourceNotFoundException("Product not found with id: " + productId));

        Sort sort = sortDir.equalsIgnoreCase("desc")
                ? Sort.by("createdAt").descending()
                : Sort.by("createdAt").ascending();

        Pageable pageable = PageRequest.of(page, size, sort);

        Page<ProductImage> imagePage = productImageRepository.findByProductId(productId, pageable);

        List<ProductImageResponseDto> images = imagePage.getContent()
                .stream()
                .map(img -> ProductImageResponseDto.builder()
                        .id(img.getId())
                        .imagePath(img.getImagePath())
                        .imageUrl(img.getImagePath())
                        .thumbnailPath(img.getThumbnailPath())
                        .thumbnailUrl(img.getThumbnailPath())
                        .build())
                .toList();

        return PagedResponseDto.<ProductImageResponseDto>builder()
                .content(images)
                .pageNumber(imagePage.getNumber())
                .pageSize(imagePage.getSize())
                .totalElements(imagePage.getTotalElements())
                .totalPages(imagePage.getTotalPages())
                .last(imagePage.isLast())
                .build();
    }
}

==================================================================================================================================

package com.advann.product_service.service.services;

import org.springframework.web.multipart.MultipartFile;

public interface S3Service {

    String uploadFile(MultipartFile file, String folder);

    String uploadBytes(byte[] bytes, String contentType, String folder);

    void deleteFileByUrl(String fileUrl);
}

===================================================================================================================================

package com.advann.product_service.service.serviceImpl;

import com.advann.product_service.exceptions.InvalidFileException;
import com.advann.product_service.service.services.S3Service;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;
import software.amazon.awssdk.core.sync.RequestBody;
import software.amazon.awssdk.services.s3.S3Client;
import software.amazon.awssdk.services.s3.model.DeleteObjectRequest;
import software.amazon.awssdk.services.s3.model.PutObjectRequest;

import java.io.IOException;
import java.util.UUID;

@Service
@RequiredArgsConstructor
public class S3ServiceImpl implements S3Service {

    private final S3Client s3Client;

    @Value("${aws.s3.bucket-name}")
    private String bucketName;

    @Value("${aws.s3.region}")
    private String region;

    @Override
    public String uploadFile(MultipartFile file, String folderName) {

        try {
            String fileName = UUID.randomUUID() + "_" + file.getOriginalFilename();
            String key = folderName + "/" + fileName;

            PutObjectRequest request = PutObjectRequest.builder()
                    .bucket(bucketName)
                    .key(key)
                    .contentType(file.getContentType())
                    .build();

            s3Client.putObject(request, RequestBody.fromBytes(file.getBytes()));

            return "https://" + bucketName + ".s3." + region + ".amazonaws.com/" + key;

        } catch (IOException e) {
            throw new InvalidFileException("Failed to upload file to S3.");
        }
    }

    @Override
    public String uploadBytes(byte[] data, String contentType, String folderName) {

        String fileName = UUID.randomUUID() + ".jpg";
        String key = folderName + "/" + fileName;

        PutObjectRequest request = PutObjectRequest.builder()
                .bucket(bucketName)
                .key(key)
                .contentType(contentType)
                .build();

        s3Client.putObject(request, RequestBody.fromBytes(data));

        return "https://" + bucketName + ".s3." + region + ".amazonaws.com/" + key;
    }

    @Override
    public void deleteFileByUrl(String fileUrl) {

        if (fileUrl == null || fileUrl.isBlank()) {
            return;
        }

        try {
            // Example URL:
            // https://bucket.s3.ap-south-1.amazonaws.com/products/full/abc.jpg
            String baseUrl = "https://" + bucketName + ".s3." + region + ".amazonaws.com/";

            if (!fileUrl.startsWith(baseUrl)) {
                throw new InvalidFileException("Invalid S3 file URL: " + fileUrl);
            }

            String key = fileUrl.substring(baseUrl.length());

            DeleteObjectRequest deleteRequest = DeleteObjectRequest.builder()
                    .bucket(bucketName)
                    .key(key)
                    .build();

            s3Client.deleteObject(deleteRequest);

        } catch (Exception e) {
            throw new InvalidFileException("Failed to delete file from S3.");
        }
    }
}

